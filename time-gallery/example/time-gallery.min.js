"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var i=0,e=Array(t.length);i<t.length;i++)e[i]=t[i];return e}return Array.from(t)}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(i,e,a){return e&&t(i.prototype,e),a&&t(i,a),i}}(),TimeGallery=function(){function t(i){return _classCallCheck(this,t),i.id?(this._stage=new createjs.Stage(document.getElementById(i.id)),this._loadQueue=null,this._isLoading=!1,this._isEnd=!1,this._isState=i.isState||!1,this._isLog=i.isLog||!1,this._isTouch=i.isTouch!==!1,this._dirGroup={horizontal:"horizontal",vertical:"vertical"},this._isVertical=(i.direction||this._dirGroup.vertical)===this._dirGroup.vertical,this._timeline=null,this._delayTime=i.delayTime||0,this._endTime=i.endTime||0,this._activeTime=i.activeTime||0,this._autoPlay=i.autoPlay||!1,this._data=i.data||[],this._objects={},this._animatorsGroup=[],this._resourcesPath=i.resourcesPath||"",this._resources=i.resources||[],this._sprites=i.sprites||{},this._touchData={touchstart:0,touchmove:0,friction:.92,speed:i.touchSpeed||1,isInertance:!1},this.width=i.width||window.innerWidth,this.height=i.height||(this.width?window.innerHeight/window.innerWidth*this.width:window.innerHeight),this.canvas=this._stage.canvas,this.canvas.width=this.width,this.canvas.height=this.height,this.onInit=i.onInit||null,this.onEnd=i.onEnd||null,this.onTickStart=i.onTickStart||null,this.onTickEnd=i.onTickEnd||null,this.onTimeToStart=i.onTimeToStart||null,this.onTimeToEnd=i.onTimeToEnd||null,this.autoSpeed=i.autoSpeed||1,this.autoUpdate=i.autoUpdate||!1,this.playLine=i.playLine||(this._isVertical?this.height:this.width),this._isTouch&&this._initTouchEvent(),void this.init()):console.error("Canvas id not exist")}return _createClass(t,[{key:"init",value:function(){var t=this;this._preload(this._resources,{path:this._resourcesPath,onComplete:function(){"function"==typeof t._sprites&&(t._sprites=t._sprites(t)),"function"==typeof t._data&&(t._data=t._data(t));var i=[{id:"_timeline",children:[{id:"_timedata",children:t._data}]}];if(t._render(i,null,function(i,e){i&&e.animation&&(i.animation=t._createAnimate(i,e.animation),t._animatorsGroup.push(i))}),t._timeline=t._objects._timeline,t._isVertical?t._objects._timedata.y=t._delayTime:t._objects._timedata.x=t._delayTime,!t._endTime){var e=void 0,a=void 0;e=t._isVertical?t._timeline.getBounds().height+t._timeline.getBounds().y-t.height:t._timeline.getBounds().width+t._timeline.getBounds().x-t.width,a=Math.max.apply(Math,t._animatorsGroup.map(function(t){return t.animation.endPlayTime})),t._endTime=Math.max(e,a)}if(t._activeTime){t._activeTime<0?t._activeTime=0:t._activeTime>t._endTime&&(t._activeTime=t._endTime);var n=-t._activeTime;t._isVertical?t._timeline.y=n:t._timeline.x=n,t._updateAnimators()}t._stage.update(),t._isState&&t._stats(),t.onInit&&t.onInit()}}),createjs.Ticker.timingMode=createjs.Ticker.RAF}},{key:"play",value:function(){var t=this;this._tickEvent&&this.stop(),this._tickEvent=function(){return t._onTick()},createjs.Ticker.addEventListener("tick",this._tickEvent)}},{key:"replay",value:function(){this._touchData.touchstart=0,this._touchData.touchmove=0,this._touchData.isInertance=!1,this._isVertical?this._timeline.y=0:this._timeline.x=0,this._animatorsGroup.forEach(function(t){t.animation.set(0)}),this._stage.update(),this.play()}},{key:"stop",value:function(){createjs.Ticker.removeEventListener("tick",this._tickEvent),this._tickEvent=null}},{key:"remove",value:function(t){var i=this._objects[t],e=i.parent;e.removeChild(i),this._stage.update(),this._removeObject(t)}},{key:"destroy",value:function(){this.stop(),this._initTouchData(),this._stage.removeAllChildren(),this._stage.update(),this._objects={},this._animatorsGroup=[],this._endTime=0,this._activeTime=0}},{key:"getActiveTime",value:function(){return this._activeTime}},{key:"getEndTime",value:function(){return this._endTime}},{key:"getObject",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(""===t)return this._objects;var i=this._objects[t];if(void 0===i)return null;var e=i.width,a=i.height,n=i.regX,s=i.regY,o=i.rotation,r=i.scaleX,h=i.scaleY,c=i.skewX,l=i.skewY,u=i.alpha,d=i.type,_=i.x,m=i.y,v=i.visible,p={id:t,width:e,height:a,regX:n,regY:s,rotation:o,scaleX:r,scaleY:h,skewX:c,skewY:l,alpha:u,type:d,x:_,y:m,visible:v,target:i};return this._isVertical?p.y=this._getObjectTime(i):p.x=this._getObjectTime(i),i.animation&&(p.animation=i.animation),p}},{key:"getImage",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""===t?this._loadQueue:this._loadQueue[t]}},{key:"getSprite",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""===t?this._sprites:this._sprites[t]}},{key:"timeTo",value:function(t){var i=this,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments[2],n=0;if("string"==typeof t){var s=t[0];switch(s){case"+":case"-":n=this._activeTime+parseInt(t);break;default:return}}else{if("number"!=typeof t)return;n=t}if(this._activeTime!==n)if(this.onTimeToStart&&this.onTimeToStart(this),0===e)this._activeTime=n,this._isVertical?this._timeline.y=-this._activeTime:this._timeline.x=-this._activeTime,this._updateAnimators(),this._stage.update(),this._onTimeToEnd(a);else{this.stop();var o=(new Date).getTime(),r=0,h=1,c=0,l=0,u=0,d=Math.abs(this._activeTime-n);this._activeTime>n&&(h=-1),this._tickEvent=function(){i.onTickStart&&i.onTickStart(i),r=(new Date).getTime(),u=(r-o)/e,l=Math.floor(u*d)*h,l>d&&(l=d),i._activeTime+=l-c,c=l,i._activeTime<0?(i._isVertical?i._activeTime=0:i._activeTime=0,i._onTimeToEnd(a)):i._activeTime>=i._endTime?(i._activeTime=i._endTime,i._onTimeToEnd(a),i._isEnd=!0,i.onEnd&&i.onEnd()):u>=1&&i._onTimeToEnd(a),i._isVertical?i._timeline.y=-i._activeTime:i._timeline.x=-i._activeTime,i._updateAnimators(),i.onTickEnd&&i.onTickEnd(i),i._stage.update()},createjs.Ticker.addEventListener("tick",this._tickEvent)}}},{key:"_onTimeToEnd",value:function(t){0!==this._touchData.touchmove&&this._initTouchData(),this.onTimeToEnd&&this.onTimeToEnd(this),t&&t(this),this.play()}},{key:"_onTick",value:function(){if(!this._isLoading&&this._timeline){if(this.autoUpdate&&this.onTickStart&&this.onTickStart(this),this._autoPlay||this._touchData.isMoving){!this.autoUpdate&&this.onTickStart&&this.onTickStart(this);var t=void 0;this._touchData.isMoving?(this._touchData.isInertance&&(this._touchData.touchmove*=this._touchData.friction,Math.abs(this._touchData.touchmove)<=1&&this._initTouchData()),this._isVertical?(this._timeline.y+=this._touchData.touchmove*this._touchData.speed,t=-this._timeline.y):(this._timeline.x+=this._touchData.touchmove*this._touchData.speed,t=-this._timeline.x),this._updateTime(t)):(this._isVertical?(this._timeline.y-=this.autoSpeed,t=-this._timeline.y):(this._timeline.x-=this.autoSpeed,t=-this._timeline.x),this._updateTime(t)),this.onTickEnd&&this.onTickEnd(this),this.autoUpdate||this._stage.update()}this.autoUpdate&&this._stage.update(),this._isState&&this.stats.update()}}},{key:"_updateTime",value:function(t){if(t<this._endTime&&(this._isEnd=!1),t<0)t=0,this._isVertical?this._timeline.y=0:this._timeline.x=0;else if(t>this._endTime){if(t=this._endTime,this._isVertical?this._timeline.y=-this._endTime:this._timeline.x=-this._endTime,this._isEnd)return;this._isEnd=!0,this.onEnd&&this.onEnd()}this._activeTime=t,this._updateAnimators()}},{key:"_updateAnimators",value:function(){var t=this._isVertical?-this._timeline.y:-this._timeline.x;this._animatorsGroup.map(function(i){var e=i.animation.startPlayTime,a=i.animation.endPlayTime;t>=e&&t<a?i.animation.update(Math.abs(t-e)):t<e?i.animation.set(0):t>=a&&i.animation.set(a-e)}),this.onTickEnd&&this.onTickEnd(this)}},{key:"_preload",value:function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=e.onComplete,n=void 0===a?function(){}:a,s=e.onProgress,o=void 0===s?function(){}:s,r=e.path,h=void 0===r?"":r;this._isLoading=!0;var c=null;if(Array.isArray(i)){if(0===i.length)return;c=i}else if("string"==typeof i)c=[{src:i,id:i}];else{if("object"!==("undefined"==typeof i?"undefined":_typeof(i)))return!1;i.id||(i.id=i.src),c=[i]}for(var l=0,u=c.length,d={},_=function(i){var e=new Image,a=c[i],s="undefined"==typeof a?"undefined":_typeof(a),r="";"object"===s?r=a.src:"string"===s&&(r=a),e.src=h+r,e.onload=function(){a.id?d[a.id]=e:d[r]=e,l++;var i=Math.floor(l/u*100);o(i),i>=100&&(t._isLoading=!1,t._loadQueue=d,n())}},m=0;m<u;m++)_(m)}},{key:"_addObject",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=null;switch(t.type){case"shape":if(i=new createjs.Shape,t.graphics){var e=!0,a=!1,n=void 0;try{for(var s,o=Object.keys(t.graphics)[Symbol.iterator]();!(e=(s=o.next()).done);e=!0){var r=s.value;if(Array.isArray(t.graphics[r])){var h;(h=i.graphics)[r].apply(h,_toConsumableArray(t.graphics[r]))}else t.graphics[r]instanceof Object?i.graphics[r](t.graphics[r]):i.graphics[r](t.graphics[r])}}catch(c){a=!0,n=c}finally{try{!e&&o["return"]&&o["return"]()}finally{if(a)throw n}}}break;case"bitmap":t.image&&(i=new createjs.Bitmap(t.image));break;case"text":i=new createjs.Text;break;case"sprite":if(t.sheet){var l=new createjs.SpriteSheet(t.sheet);i=new createjs.Sprite(l)}break;default:i=new createjs.Container}if(t.type?i.type=t.type:i.type="container",t.id&&(i.name=t.id),t.parent_id&&(i.parent_id=t.parent_id),t.prop){var u=!0,d=!1,_=void 0;try{for(var m,v=Object.keys(t.prop)[Symbol.iterator]();!(u=(m=v.next()).done);u=!0){var p=m.value;switch(p){case"index":break;default:if(i[p]instanceof Object){var y=!0,f=!1,T=void 0;try{for(var g,b=Object.keys(t.prop[p])[Symbol.iterator]();!(y=(g=b.next()).done);y=!0){var k=g.value;if("function"==typeof i[p][k]){var j;(j=i[p])[k].apply(j,_toConsumableArray(t.prop[p][k]))}else i[p][k]=t.prop[p][k]}}catch(c){f=!0,T=c}finally{try{!y&&b["return"]&&b["return"]()}finally{if(f)throw T}}}else if("function"==typeof i[p]){var w;(w=i)[p].apply(w,_toConsumableArray(t.prop[p]))}else i[p]=t.prop[p]}}}catch(c){d=!0,_=c}finally{try{!u&&v["return"]&&v["return"]()}finally{if(d)throw _}}if("text"===t.type&&t.prop.align)switch(t.prop.align){case"center":i.x=(this.width-i.getBounds().width)/2;break;case"right":i.x=this.width-i.getBounds().width;break;default:i.x=0}}if(t.methods){var E=!0,x=!1,D=void 0;try{for(var S,A=Object.keys(t.methods)[Symbol.iterator]();!(E=(S=A.next()).done);E=!0){var C,I=S.value;(C=i)[I].apply(C,_toConsumableArray(t.methods[I]))}}catch(c){x=!0,D=c}finally{try{!E&&A["return"]&&A["return"]()}finally{if(x)throw D}}}if(t.events&&t.events.handle){var L=t.events.type||"click";i.addEventListener(L,t.events.handle)}return i}},{key:"_removeObject",value:function(t){var i=this,e=this._objects[t];delete this._objects[t],e.animation&&this._removeAnimator(e.name);var a=e.children;a&&a.forEach(function(t){delete i._objects[t.name],t.children&&i._removeObject(t),t.animation&&i._removeAnimator(t.name)})}},{key:"_removeAnimator",value:function(t){for(var i=0,e=this._animatorsGroup.length;i<e;i++)if(this._animatorsGroup[i].name===t)return void this._animatorsGroup.splice(i,1)}},{key:"_render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=this,e=arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};t instanceof Object&&(t=Array.from(t)),t.map(function(t,n){return t.parent_id=e,void 0===t.id&&(t.id=e+"_"+n),i._objects[t.id]?void console.error("Data id:'"+t.id+"' is it exists already"):(i._objects[t.id]=i._addObject(t),i._isLog&&(console.group(t.id+":"),console.table({x:i._objects[t.id].x,y:i._objects[t.id].y,regX:i._objects[t.id].regX,regY:i._objects[t.id].regY,scaleX:i._objects[t.id].scaleX,scaleY:i._objects[t.id].scaleY,rotation:i._objects[t.id].rotation,alpha:i._objects[t.id].alpha,visible:i._objects[t.id].visible})),e?i._objects[e].addChild(i._objects[t.id]):i._stage.addChild(i._objects[t.id]),a&&a(i._objects[t.id],t),t.children&&i._render(t.children,t.id,a),void(i._isLog&&console.groupEnd()))}),t.map(function(t){if(e&&t.prop&&t.prop.index){var a=t.prop.index,n=i._objects[e].numChildren;a>n&&(a=n-1),i._objects[e].setChildIndex(i._objects[t.id],a),console.log(i._objects[e].getChildIndex(i._objects[t.id]))}}),this._stage.update()}},{key:"_createAnimate",value:function(t){function i(i){var e=i/w;if(x.length>1){var a=x.length,n=w/a,s=Math.min(i/n|0,a-1);t.image=x[s]}(G||0===G)&&(t.x=e*(G-B)+B),(U||0===U)&&(t.y=e*(U-M)+M),(h||0===h)&&(t.scaleX=e*(h-z)+z),(l||0===l)&&(t.scaleY=e*(l-H)+H),(d||0===d)&&(t.skewX=e*(d-W)+W),(m||0===m)&&(t.skewY=e*(m-F)+F),(p||0===p)&&(t.rotation=e*(p-R)+R),(f||0===f)&&(t.alpha=e*(f-Q)+Q)}var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=e.x,n=void 0===a?null:a,s=e.y,o=void 0===s?null:s,r=e.scaleX,h=void 0===r?null:r,c=e.scaleY,l=void 0===c?null:c,u=e.skewX,d=void 0===u?null:u,_=e.skewY,m=void 0===_?null:_,v=e.rotation,p=void 0===v?null:v,y=e.alpha,f=void 0===y?1:y,T=e.top,g=void 0===T?0:T,b=e.delay,k=void 0===b?0:b,j=e.duration,w=void 0===j?0:j,E=e.sprite,x=void 0===E?[]:E,D=e.startById,S=void 0===D?null:D,A=e.endById,C=void 0===A?null:A,I=e.afterById,L=void 0===I?null:I,V=e.musicById,X=void 0===V?null:V,Y=e.musicStopById,O=void 0===Y?null:Y,P=this._getObjectTime(t)+this._delayTime,B=t.x,M=t.y,G=n,U=o,Q=t.alpha,z=t.scaleX,H=t.scaleY,W=t.skewX,F=t.skewY,R=t.rotation,q=!1,J=!1,K=null,N=null,Z=0,$=0;return g&&(k=-g),Z=S?this._objects[S].animation.startPlayTime+k:L?this._objects[L].animation.endPlayTime+k:C?this._objects[C].animation.endPlayTime-w+k:P+k>=this.playLine?P+k-this.playLine:0,$=C?this._objects[C].animation.endPlayTime:Z+w,X&&(K=document.getElementById(X)),O&&(N=document.getElementById(O)),{startPlayTime:Z,endPlayTime:$,update:function(t){var e=t/w;(0!==e&&1!==e||J!==!1)&&(e>=1?(e=1,J=!1):e<=0?(e=0,J=!1):J=!0,K&&(q===!1?(K.currentTime=0,K.play(),q=!0):q===!0&&0===e&&(K.paused||(K.pause(),q=!1))),N&&(N.paused||N.pause()),i(t))},set:function(t){J&&(J=!1),q&&(q=!1),i(t)}}}},{key:"_getObjectTime",value:function(t){function i(t){var n=t.parent;n&&"_timeline"!==n.name&&(e+=a._isVertical?n.y:n.x,i(n))}var e=this._isVertical?t.y:t.x,a=this;return i(t),e}},{key:"_initTouchEvent",value:function(){var t=this;this.canvas.addEventListener("touchstart",function(i){t._isVertical?t._touchData.touchstart=i.touches[0].clientY:t._touchData.touchstart=i.touches[0].clientX,t._touchData.isInertance=!1,t._touchData.isMoving=!1}),this.canvas.addEventListener("touchmove",function(i){t._isVertical?(t._touchData.touchmove=i.touches[0].clientY-t._touchData.touchstart,t._touchData.touchstart=i.touches[0].clientY):(t._touchData.touchmove=i.touches[0].clientX-t._touchData.touchstart,t._touchData.touchstart=i.touches[0].clientX),t._touchData.isMoving=!0}),this.canvas.addEventListener("touchend",function(){t._touchData.isInertance=!0})}},{key:"_initTouchData",value:function(){this._touchData.touchstart=0,this._touchData.touchmove=0,this._touchData.isInertance=!1,this._touchData.isMoving=!1}},{key:"_stats",value:function(){this.stats=new Stats,this.stats.showPanel(0),document.body.appendChild(this.stats.dom)}}]),t}();